input {
    jdbc {
        jdbc_connection_string => "jdbc:oracle:thin:@prodh-scan.ash.broadcom.net:1535/LRCSPROD"
        jdbc_user => "ELASTIC_SEARCH"
        jdbc_password => "Pa$wd#elA$t"
        jdbc_validate_connection => true
        jdbc_driver_library => "C:/tmp/ojdbc8-12.2.0.1.jar"
        jdbc_driver_class => "Java::oracle.jdbc.driver.OracleDriver"        
        # Every 15 min
        schedule => "*/5 * * * *"
        statement => " select * from (  SELECT user_id, email, CAST(collect(TO_CHAR(document_id) ) AS sys.dbmsoutput_linesarray) document_id,  CAST(collect(TO_CHAR(access_profile_id) ) AS sys.dbmsoutput_linesarray) access_profile_id FROM      ((SELECT P.USER_ID, P.EMAIL,P.DOCUMENT_ID, null as access_profile_id       from (         SELECT U.USER_ID, U.LOGIN_NAME AS EMAIL,Q.DOCUMENT_ID          FROM MASTER.MASTER_USER U          INNER JOIN          (SELECT USER_ID,DOCUMENT_ID          FROM CSP.CSP_PERMISSIONS          WHERE (CREATE_DATE >= trunc(SYSTIMESTAMP) OR UPDATE_DATE >= trunc(SYSTIMESTAMP))          UNION          SELECT PU.USER_ID,PD.DOCUMENTID DOCUMENT_ID          FROM CSP.CSP_PERMISSION_DOCUMENTS PD          INNER JOIN CSP.CSP_PERMISSIONGROUP_USERS PU          ON PD.PERMISSIONGROUPID = PU.PERMISSIONGROUP_ID          WHERE (PD.CREATE_DATE >= trunc(SYSTIMESTAMP) OR PD.UPDATE_DATE >= trunc(SYSTIMESTAMP)          OR PU.CREATE_DATE >= trunc(SYSTIMESTAMP) OR PU.UPDATE_DATE >= trunc(SYSTIMESTAMP))          UNION          SELECT DPUSERS.USER_ID,DPDOC.DOCUMENT_ID          FROM CSP.CSP_PROGRAMS DP          INNER JOIN CSP.CSP_PROGRAMUSERS DPUSERS          ON DP.PROGRAM_ID = DPUSERS.PROGRAM_ID          INNER JOIN MASTER.MASTER_USER U          ON DPUSERS.USER_ID = U.USER_ID          INNER JOIN CSP.CSP_PROGRAMPRODUCTS DPPROD          ON DP.PROGRAM_ID = DPPROD.PROGRAM_ID          INNER JOIN CSP.CSP_PRODUCT_DOCUMENTS DPDOC          ON DPPROD.PRODUCT_ID = DPDOC.PRODUCT_TAXID          INNER JOIN CSP.CSP_DOCUMENT DOC          ON DPDOC.DOCUMENT_ID = DOC.DOCUMENT_ID          WHERE DP.ACTIVE = 'Y'          AND DP.PROGRAM_STATUS_ID = 3          AND DOC.ISSOFTWARE = 'N'          AND DOC.STATUS = 'Available'          AND U.COMPLIANCE_STATUS = 'Y'          AND DOC.DOC_CATEGORY IN ('CAT-2','CAT-3')          AND DOC.DOCUMENT_ID NOT IN ( SELECT SWA.DOCUMENT_ID FROM CSP.CSP_SWATTRIBUTES SWA WHERE SWA.DOCUMENT_ID = DOC.DOCUMENT_ID )          AND ((CASE WHEN DPPROD.INCLUDE_PUBLIC = 'Y'                     THEN 2                END) = DOC.AUDIENCE                OR (CASE WHEN DPPROD.INCLUDE_INTERNAL = 'Y'                         THEN 4                    END) = DOC.AUDIENCE                OR (CASE WHEN DPPROD.INCLUDE_COMPANY_SPECIFIC = 'Y'                    THEN DOC.AUDIENCE                    END) IN                          (SELECT DAC.AUDIENCE_ID FROM CSP.CSP_PROGRAMS P                          INNER JOIN CSP.CSP_PROGRAMNDAS PC                          ON P.PROGRAM_ID = PC.PROGRAM_ID                          INNER JOIN MASTER.MASTER_COMPANY C                          ON PC.COMPANY_ID = C.COMPANY_ID                          INNER JOIN CSP.CSP_DOCAUDIENCECOMPANIES DAC                          ON C.COMPANY_ID = DAC.COMPANY_ID ) )          AND DOC.DOCTYPE_ID NOT IN                          (SELECT CSP_PROGRAMPRODUCTDOCTYPE.DOCTYPE_ID                          FROM CSP.CSP_PROGRAMPRODUCTDOCTYPE                          WHERE PROGRAM_ID = DP.PROGRAM_ID                          AND PRODUCT_ID = DPPROD.PRODUCT_ID )          AND (DP.CREATE_DATE >= trunc(SYSTIMESTAMP) OR DP.UPDATE_DATE >= trunc(SYSTIMESTAMP)              OR DPUSERS.CREATE_DATE >= trunc(SYSTIMESTAMP) OR DPUSERS.UPDATE_DATE >= trunc(SYSTIMESTAMP)              OR U.CREATE_DATE >= trunc(SYSTIMESTAMP) OR U.UPDATE_DATE >= trunc(SYSTIMESTAMP)              OR DPPROD.CREATE_DATE >= trunc(SYSTIMESTAMP) OR DPPROD.UPDATE_DATE >= trunc(SYSTIMESTAMP)              OR DPDOC.CREATE_DATE >= trunc(SYSTIMESTAMP) OR DPDOC.UPDATE_DATE >= trunc(SYSTIMESTAMP)              OR DOC.CREATE_DATE >= trunc(SYSTIMESTAMP) OR DOC.UPDATE_DATE >= trunc(SYSTIMESTAMP)) ) Q      ON U.USER_ID = Q.USER_ID      WHERE (U.CREATE_DATE >= trunc(SYSTIMESTAMP) OR U.UPDATE_DATE >= trunc(SYSTIMESTAMP)) ) p)     union     (SELECT usr.user_id,usr.login_name as email,doc_map.document_id as document_id,     ac_pf.access_profile_id AS access_profile_id     FROM master.master_access_profile ac_pf      INNER JOIN master.master_document_mapper doc_map      ON ac_pf.access_profile_id = doc_map.access_profile_id      inner join MASTER.master_user_profile_mapper user_pf_map      on ac_pf.access_profile_id = user_pf_map.profile_id      inner join MASTER.master_user usr on user_pf_map.user_id = usr.user_id      WHERE ( trunc(doc_map.update_date) = trunc(SYSDATE) OR trunc(doc_map.create_date) = trunc(SYSDATE) )              OR ( trunc(user_pf_map.update_date) = trunc(SYSDATE) OR trunc(user_pf_map.create_date) = trunc(SYSDATE) )      AND user_pf_map.ISACTIVE='Y'     ))     where access_profile_id not like '%()%'     GROUP BY USER_ID,EMAIL)"
    
    }    
}



output {

    stdout {
        codec => json
    }
 
        elasticsearch {
        hosts => ["http://10.85.18.37:9200"]
        index => "csp_permission_logstash_test_v1"
        #document_id => "%{defectid}"
        user => "elastic"
        password => "elastic123"
    }
    
}
